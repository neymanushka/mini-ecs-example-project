!function(){"use strict";function t(t){if(this.words=[],t)if(Symbol&&Symbol.iterator&&void 0!==t[Symbol.iterator])for(var e=t[Symbol.iterator](),s=e.next();!s.done;)this.add(s.value),s=e.next();else for(var o=0;o<t.length;o++)this.add(t[o])}t.prototype.add=function(t){this.resize(t),this.words[t>>>5]|=1<<t},t.prototype.flip=function(t){this.resize(t),this.words[t>>>5]^=1<<t},t.prototype.clear=function(){this.words=[]},t.prototype.remove=function(t){this.resize(t),this.words[t>>>5]&=~(1<<t)},t.prototype.isEmpty=function(t){for(var e=this.words.length,s=0;s<e;s++)if(0!==this.words[s])return!1;return!0},t.prototype.has=function(t){return 0!=(this.words[t>>>5]&1<<t)},t.prototype.checkedAdd=function(t){this.resize(t);var e=this.words[t>>>5],s=e|1<<t;return this.words[t>>>5]=s,(s^e)>>>t},t.prototype.trim=function(t){for(var e=this.words.length;e>0&&0===this.words[e-1];)e--;this.words=this.words.slice(0,e)},t.prototype.resize=function(t){for(var e=t+32>>>5,s=this.words.length;s<e;s++)this.words[s]=0},t.prototype.hammingWeight=function(t){return 16843009*((t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)>>>24},t.prototype.hammingWeight4=function(t,e,s,o){return 16843009*((t=(t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)+(e=(e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)+(s=(s=(858993459&(s-=s>>>1&1431655765))+(s>>>2&858993459))+(s>>>4)&252645135)+(o=(o=(858993459&(o-=o>>>1&1431655765))+(o>>>2&858993459))+(o>>>4)&252645135))>>>24},t.prototype.size=function(){for(var t=0,e=this.words.length,s=this.words,o=0;o<e;o++)t+=this.hammingWeight(s[o]);return t},t.prototype.array=function(){for(var t=new Array(this.size()),e=0,s=this.words.length,o=0;o<s;++o)for(var r=this.words[o];0!=r;){var i=r&-r;t[e++]=(o<<5)+this.hammingWeight(i-1|0),r^=i}return t},t.prototype.forEach=function(t){for(var e=this.words.length,s=0;s<e;++s)for(var o=this.words[s];0!=o;){var r=o&-o;t((s<<5)+this.hammingWeight(r-1|0)),o^=r}},t.prototype[Symbol.iterator]=function*(){for(var t=this.words.length,e=0;e<t;++e)for(var s=this.words[e];0!=s;){var o=s&-s;yield(e<<5)+this.hammingWeight(o-1|0),s^=o}},t.prototype.clone=function(){var e=Object.create(t.prototype);return e.words=this.words.slice(),e},t.prototype.intersects=function(t){for(var e=Math.min(this.words.length,t.words.length),s=0;s<e;++s)if(0!=(this.words[s]&t.words[s]))return!0;return!1},t.prototype.intersection=function(t){for(var e=Math.min(this.words.length,t.words.length),s=0;s+7<e;s+=8)this.words[s]&=t.words[s],this.words[s+1]&=t.words[s+1],this.words[s+2]&=t.words[s+2],this.words[s+3]&=t.words[s+3],this.words[s+4]&=t.words[s+4],this.words[s+5]&=t.words[s+5],this.words[s+6]&=t.words[s+6],this.words[s+7]&=t.words[s+7];for(;s<e;++s)this.words[s]&=t.words[s];var o=this.words.length;for(s=e;s<o;++s)this.words[s]=0;return this},t.prototype.intersection_size=function(t){for(var e=Math.min(this.words.length,t.words.length),s=0,o=0;o<e;++o)s+=this.hammingWeight(this.words[o]&t.words[o]);return s},t.prototype.new_intersection=function(e){var s=Object.create(t.prototype),o=Math.min(this.words.length,e.words.length);s.words=new Array(o);for(var r=o,i=0;i+7<r;i+=8)s.words[i]=this.words[i]&e.words[i],s.words[i+1]=this.words[i+1]&e.words[i+1],s.words[i+2]=this.words[i+2]&e.words[i+2],s.words[i+3]=this.words[i+3]&e.words[i+3],s.words[i+4]=this.words[i+4]&e.words[i+4],s.words[i+5]=this.words[i+5]&e.words[i+5],s.words[i+6]=this.words[i+6]&e.words[i+6],s.words[i+7]=this.words[i+7]&e.words[i+7];for(;i<r;++i)s.words[i]=this.words[i]&e.words[i];return s},t.prototype.equals=function(t){for(var e=Math.min(this.words.length,t.words.length),s=0;s<e;++s)if(this.words[s]!=t.words[s])return!1;if(this.words.length<t.words.length){var o=t.words.length;for(s=this.words.length;s<o;++s)if(0!=t.words[s])return!1}else if(t.words.length<this.words.length)for(o=this.words.length,s=t.words.length;s<o;++s)if(0!=this.words[s])return!1;return!0},t.prototype.difference=function(t){for(var e=Math.min(this.words.length,t.words.length),s=0;s+7<e;s+=8)this.words[s]&=~t.words[s],this.words[s+1]&=~t.words[s+1],this.words[s+2]&=~t.words[s+2],this.words[s+3]&=~t.words[s+3],this.words[s+4]&=~t.words[s+4],this.words[s+5]&=~t.words[s+5],this.words[s+6]&=~t.words[s+6],this.words[s+7]&=~t.words[s+7];for(;s<e;++s)this.words[s]&=~t.words[s];return this},t.prototype.new_difference=function(t){return this.clone().difference(t)},t.prototype.difference_size=function(t){for(var e=Math.min(this.words.length,t.words.length),s=0,o=0;o<e;++o)s+=this.hammingWeight(this.words[o]&~t.words[o]);for(var r=this.words.length;o<r;++o)s+=this.hammingWeight(this.words[o]);return s},t.prototype.change=function(t){for(var e=Math.min(this.words.length,t.words.length),s=0;s+7<e;s+=8)this.words[s]^=t.words[s],this.words[s+1]^=t.words[s+1],this.words[s+2]^=t.words[s+2],this.words[s+3]^=t.words[s+3],this.words[s+4]^=t.words[s+4],this.words[s+5]^=t.words[s+5],this.words[s+6]^=t.words[s+6],this.words[s+7]^=t.words[s+7];for(;s<e;++s)this.words[s]^=t.words[s];if(t.words.length>this.words.length)for(var o=t.words.length;s<o;++s)this.words[s]=t.words[s];return this},t.prototype.new_change=function(t){return t.words.length>this.words.length?this.clone().change(t):t.clone().change(this)},t.prototype.change_size=function(t){for(var e=Math.min(this.words.length,t.words.length),s=0,o=0;o<e;++o)s+=this.hammingWeight(this.words[o]^t.words[o]);for(var r=this.words.length>t.words.length?this:t,i=r.words.length;o<i;++o)s+=this.hammingWeight(r.words[o]);return s},t.prototype.toString=function(){return"{"+this.array().join(",")+"}"},t.prototype.union=function(t){for(var e=Math.min(this.words.length,t.words.length),s=0;s+7<e;s+=8)this.words[s]|=t.words[s],this.words[s+1]|=t.words[s+1],this.words[s+2]|=t.words[s+2],this.words[s+3]|=t.words[s+3],this.words[s+4]|=t.words[s+4],this.words[s+5]|=t.words[s+5],this.words[s+6]|=t.words[s+6],this.words[s+7]|=t.words[s+7];for(;s<e;++s)this.words[s]|=t.words[s];if(this.words.length<t.words.length){this.resize((t.words.length<<5)-1);var o=t.words.length;for(s=e;s<o;++s)this.words[s]=t.words[s]}return this},t.prototype.new_union=function(e){var s=Object.create(t.prototype),o=Math.max(this.words.length,e.words.length);s.words=new Array(o);for(var r=Math.min(this.words.length,e.words.length),i=0;i+7<r;i+=8)s.words[i]=this.words[i]|e.words[i],s.words[i+1]=this.words[i+1]|e.words[i+1],s.words[i+2]=this.words[i+2]|e.words[i+2],s.words[i+3]=this.words[i+3]|e.words[i+3],s.words[i+4]=this.words[i+4]|e.words[i+4],s.words[i+5]=this.words[i+5]|e.words[i+5],s.words[i+6]=this.words[i+6]|e.words[i+6],s.words[i+7]=this.words[i+7]|e.words[i+7];for(;i<r;++i)s.words[i]=this.words[i]|e.words[i];var n=this.words.length;for(i=r;i<n;++i)s.words[i]=this.words[i];var h=e.words.length;for(i=r;i<h;++i)s.words[i]=e.words[i];return s},t.prototype.union_size=function(t){for(var e=Math.min(this.words.length,t.words.length),s=0,o=0;o<e;++o)s+=this.hammingWeight(this.words[o]|t.words[o]);if(this.words.length<t.words.length){var r=t.words.length;for(o=this.words.length;o<r;++o)s+=this.hammingWeight(0|t.words[o])}else for(r=this.words.length,o=t.words.length;o<r;++o)s+=this.hammingWeight(0|this.words[o]);return s};var e,s,o=t;class r{constructor(t){this.entities=new Map,this.mask=t}}class i{constructor(t,e){this.removed=!1,this.world=e,this.id=t,this.mask=new o,this.components=new Map}getComponent(t){return this.components.get(t.name)}addComponent(t){const e=this.world.registerComponent(t.constructor.name);return this.mask.add(e),this.components.set(t.constructor.name,t),this.world.updateQueries(this),this}removeComponent(t){const e=this.world.registerComponent(t.name);this.mask.remove(e),this.components.delete(t.name),this.world.updateQueries(this)}}class n{constructor(){this.nextId=1,this.components=new Map,this.entities=new Map,this.queries=new Map,this.systems=new Map,this.removedEntities=new Set}registerSystem(t){this.systems.set(t.constructor.name,t)}update(...t){for(const e of this.systems.values())e.update(...t);for(const t of this.removedEntities.values()){for(const e of this.queries.values())e.entities.delete(t.id);this.entities.delete(t.id)}this.removedEntities.clear()}updateQueries(t){for(const e of this.queries.values()){const s=e.mask.difference_size(t.mask),o=e.entities.has(t.id);o||0!==s?o&&0!==s&&e.entities.delete(t.id):e.entities.set(t.id,t)}}createQuery(t){const e=new o;t.forEach((t=>e.add(this.registerComponent(t.name))));const s=e.toString();let i=this.queries.get(s);if(!i){i=new r(e);for(const t of this.entities.values())0===e.difference_size(t.mask)&&i.entities.set(t.id,t);this.queries.set(s,i)}return i}registerComponent(t){let e=this.components.get(t);return void 0===e&&(e=this.components.size,this.components.set(t,e)),e}removeEntity(t){t.removed=!0,this.removedEntities.add(t)}addEntity(t){const e=t||(this.nextId++).toString(),s=new i(e,this);return this.entities.set(e,s),s}}class h{constructor(t=0,e=0){this.x=t,this.y=e}mul(t){return new h(this.x*t,this.y*t)}rotate(t){const e=Math.cos(t),s=Math.sin(t),o=this.x*e-this.y*s,r=this.x*s+this.y*e;return new h(o,r)}add(t){return new h(t.x+this.x,t.y+this.y)}sub(t){return new h(this.x-t.x,this.y-t.y)}distance(t){const e=this.x-t.x,s=this.y-t.y;return Math.sqrt(e*e+s*s)}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}norm(){const t=this.length();return t?new h(this.x/t,this.y/t):new h}}class d{constructor(t=0,e=0){this.angle=0,this.position=new h(t,e)}}class a{constructor(t,e,s){this.health=50,this.waypointIndex=0,this.target=null,this.road=t,this.color=e,this.size=s}}class w{constructor(t){this.shootDelay=0,this.target=null,this.type=t}}class c{}class l{}class p{}p.roads={upperWay:[{x:100,y:100},{x:500,y:100},{x:500,y:500},{x:900,y:500},{x:900,y:300},{x:1200,y:300}],bottomWay:[{x:100,y:100},{x:500,y:100},{x:500,y:500},{x:700,y:500},{x:700,y:800},{x:1400,y:800}]},p.nextWaveDelay=0,p.currentWave=0;class u{constructor(t){this.world=t;const e=document.querySelector("canvas");this.context=e.getContext("2d"),this.updateCanvasSize(),this.enemies=this.world.createQuery([d,a]),this.towers=this.world.createQuery([d,w]),this.bullets=this.world.createQuery([d,l]),this.missiles=this.world.createQuery([d,c]),window.addEventListener("resize",(()=>this.updateCanvasSize()))}updateCanvasSize(){this.context.canvas.width=window.innerWidth,this.context.canvas.height=window.innerHeight}drawCircle(t,e,s,o=0,r=2*Math.PI){this.context.fillStyle=s,this.context.beginPath(),this.context.arc(t.x,t.y,e,o,r),this.context.fill()}drawRect(t,e,s,o=0){this.context.save(),this.context.translate(t.x,t.y),this.context.rotate(o),this.context.translate(-t.x,-t.y),this.context.fillStyle=s,this.context.fillRect(t.x-.5*e,t.y-.5*e,e,e),this.context.restore()}drawRoad(){for(const t of Object.values(p.roads)){for(const[e,s]of t.entries())0===e&&(this.context.beginPath(),this.context.moveTo(s.x,s.y)),this.context.lineTo(s.x,s.y);this.context.lineWidth=100,this.context.stroke()}}update(){this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.drawRoad(),this.towers.entities.forEach((t=>{const e=t.getComponent(d),s="BULLETS"===t.getComponent(w).type?"blue":"blueviolet";this.drawRect(e.position,100,s,e.angle)})),this.enemies.entities.forEach((t=>{const e=t.getComponent(d).position,s=t.getComponent(a),o=Math.PI/100*(2*s.health);this.drawCircle(e,s.size,"red"),this.drawCircle(e,s.size,s.color,.5*Math.PI-o,.5*Math.PI+o)})),this.bullets.entities.forEach((t=>{const e=t.getComponent(d).position;this.drawCircle(e,10,"yellow")})),this.missiles.entities.forEach((t=>{const e=t.getComponent(d).position;this.drawCircle(e,50,"red")}))}}class m{constructor(t,e){this.scalarSpeed=t,this.direction=e}}class g{constructor(t){this.world=t,this.enemies=this.world.createQuery([d,a])}update(t){this.enemies.entities.forEach((e=>{const s=e.getComponent(d),o=e.getComponent(m),r=e.getComponent(a);r.target||(r.waypointIndex=0,r.target=new h(p.roads[r.road][0].x,p.roads[r.road][0].y),o.direction=r.target.sub(s.position).norm(),s.position=r.target);if(r.target.distance(s.position)<o.scalarSpeed*t)if(r.waypointIndex++,r.waypointIndex<p.roads[r.road].length){const t=p.roads[r.road][r.waypointIndex];r.target=new h(t.x,t.y),o.direction=r.target.sub(s.position).norm()}else this.world.removeEntity(e)}))}}class y{constructor(t){this.enemy=Object.assign({},t,{spawned:0,timePassed:0})}}!function(t){t[t.blue=0]="blue",t[t.yellow=1]="yellow",t[t.green=2]="green",t[t.white=3]="white",t[t.blueviolet=4]="blueviolet"}(e||(e={})),function(t){t[t.upperWay=0]="upperWay",t[t.bottomWay=1]="bottomWay"}(s||(s={}));const f=2*Math.PI,v=(t,e)=>Math.random()*(e-t)+t,x=t=>{const e=Object.values(t).filter(isNaN);return e[Math.floor(v(0,e.length))]};class C{constructor(t){this.world=t,this.progressBar=document.querySelector(".wave-progress-bar"),this.wave=this.world.createQuery([y])}update(t){if(p.nextWaveDelay<=0){const t=x(e),o=x(s),r=Math.floor(v(10,40)),i=Math.floor(v(2,7)),n=v(.05,.5),h={color:t,size:r,count:i,road:o,delay:30*r*(.6-n),speed:n};this.world.addEntity().addComponent(new y(h)),p.nextWaveDelay=5e3}else p.nextWaveDelay-=t}}class E{constructor(t){this.world=t,this.enemies=this.world.createQuery([d,a]),this.waves=this.enemies=this.world.createQuery([y])}spawnEnemy(t,e,s){this.world.addEntity().addComponent(new d(e,s)).addComponent(new m(t.speed,new h)).addComponent(new a(t.road,t.color,t.size))}update(t){this.waves.entities.forEach((e=>{const s=e.getComponent(y).enemy;s.timePassed>=s.delay?(s.spawned++,s.timePassed=0,this.spawnEnemy(s,p.roads[s.road][0].x,p.roads[s.road][0].y),s.spawned===s.count&&this.world.removeEntity(e)):s.timePassed+=t}))}}class S{}class M{constructor(t){this.target=t}}class b{constructor(t){this.ttl=t}}class W{constructor(t){this.damage=t}}class z{constructor(t){let e,s;this.world=t,this.enemies=this.world.createQuery([d,a]),this.towers=this.world.createQuery([d,w]),document.addEventListener("dragend",(o=>{const r=o.target.classList.contains("tower-type-one")?"BULLETS":"MISSILES";t.addEntity().addComponent(new d(e,s)).addComponent(new w(r))})),document.addEventListener("dragover",(t=>{e=t.clientX,s=t.clientY}));document.querySelector(".clear-button > button").addEventListener("click",(()=>{this.towers.entities.forEach((t=>{this.world.removeEntity(t)}))}))}spawnProjectile(t,e,s=new h){return this.world.addEntity().addComponent(new d(t.x,t.y)).addComponent(new S).addComponent(new W(e)).addComponent(new m(.5,s))}spawnBullet(t,e){const s=e.sub(t).norm();this.spawnProjectile(t,10,s).addComponent(new l).addComponent(new b(700))}spawnMissile(t,e){this.spawnProjectile(t,20).addComponent(new c).addComponent(new M(e))}lockTarget(t,e,s){const o=e.x-t.x,r=e.y-t.y;return((t,e,s)=>{const o=(e-t)%f;return t+(2*o%f-o)*s})(s,Math.atan2(r,o),.05)}update(t){this.towers.entities.forEach((e=>{const s=e.getComponent(w),o="MISSILES"===s.type?1500:500,r=1500===o?2e3:300,i=e.getComponent(d),n=i.position;let h;if(s.target=null,this.enemies.entities.forEach((t=>{const e=t.getComponent(d).position,r=n.distance(e);r<=o&&(h>r||!h)&&(h=r,s.target=t.id)})),s.target){const t=this.world.entities.get(s.target);if(t){const e=t.getComponent(d).position;i.angle=this.lockTarget(e,n,i.angle),s.shootDelay<=0&&("BULLETS"===s.type?this.spawnBullet(n,e):this.spawnMissile(n,s.target),s.shootDelay=r)}}s.shootDelay-=t}))}}class L{constructor(t){this.world=t,this.enemies=this.world.createQuery([d,a]),this.projectiles=this.world.createQuery([d,S,W])}update(){this.enemies.entities.forEach((t=>{const e=t.getComponent(d).position;for(const s of this.projectiles.entities.values()){const o=s.getComponent(W).damage,r=s.getComponent(d).position;if(e.distance(r)<=35){const e=t.getComponent(a);if(e.health-=o,this.world.removeEntity(s),e.health<1){this.world.removeEntity(t),e.health=1;break}}}}))}}class Q{constructor(t){this.world=t,this.entitiesDiv=document.querySelector(".entities"),this.dtDiv=document.querySelector(".delta-time")}update(t){this.dtDiv.innerHTML=`dt: ${Math.floor(t)}`,this.entitiesDiv.innerHTML=`entities: ${this.world.entities.size}`}}class j{constructor(t){this.world=t,this.projectiles=this.world.createQuery([d,m])}update(t){this.projectiles.entities.forEach((e=>{const s=e.getComponent(d),o=e.getComponent(m),r=o.direction.norm().mul(o.scalarSpeed*t).add(s.position);s.position=r}))}}class I{constructor(t){this.world=t,this.projectiles=this.world.createQuery([d,M,m])}update(){this.projectiles.entities.forEach((t=>{const e=t.getComponent(d),s=t.getComponent(m),o=t.getComponent(M).target,r=this.world.entities.get(o);if(r){const t=r.getComponent(d).position.sub(e.position).norm();s.direction=t}else t.removeComponent(M),t.addComponent(new b(3e3))}))}}class q{constructor(t){this.world=t,this.projectiles=this.world.createQuery([b])}update(t){this.projectiles.entities.forEach((e=>{const s=e.getComponent(b);s.ttl-=t,s.ttl<0&&this.world.removeEntity(e)}))}}const P=[{type:"BULLETS",x:300,y:300},{type:"MISSILES",x:1200,y:600},{type:"BULLETS",x:700,y:300}];window.onload=()=>{const t=new n;t.registerSystem(new u(t)),t.registerSystem(new C(t)),t.registerSystem(new g(t)),t.registerSystem(new E(t)),t.registerSystem(new z(t)),t.registerSystem(new L(t)),t.registerSystem(new Q(t)),t.registerSystem(new j(t)),t.registerSystem(new I(t)),t.registerSystem(new q(t));for(const e of P)t.addEntity().addComponent(new d(e.x,e.y)).addComponent(new w(e.type));let e=16;const s=(o=0)=>{const r=o-e;r>=1&&(e=o,t.update(r)),requestAnimationFrame(s)};s()}}();
